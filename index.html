<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pelamar CAREER SIMGROUP</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- SheetJS untuk export Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --ink:#0e1726;
      --muted:#6b7280;
      --brand:#1e97b3;
      --line:#e5e7eb;
      --chip:#eef7fb;
      --radius:16px;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: 'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:var(--bg);
    }

    .hidden{display:none !important;}

    .header{ position:sticky; top:0; z-index:10; background:var(--card); border-bottom:1px solid var(--line); }
    .header-inner{ max-width:1200px; margin:0 auto; padding:12px 20px; display:flex; gap:12px; align-items:center; justify-content:space-between;}
    .left-head{display:flex; gap:12px; align-items:center;}
    .logo{ width:32px; height:32px; border-radius:8px; object-fit:contain; background:#fff; border:1px solid var(--line); }
    .title{ font-weight:700; font-size:18px; letter-spacing:.2px; }
    .session{display:flex; align-items:center; gap:10px; font-size:13px; color:var(--muted)}
    .logout-btn{ border:1px solid var(--line); background:#fff; color:var(--ink); padding:8px 12px; border-radius:999px; font-weight:600; font-size:12px; cursor:pointer; }
    .logout-btn:hover{ background:#f3f4f6 }

    .container{max-width:1200px; margin:18px auto; padding:0 20px;}
    .grid{ display:grid; grid-template-columns:300px 1fr; gap:16px; }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .panel{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:14px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .panel h3{ margin:0 0 12px 0; font-size:14px; font-weight:700; }
    .filters{ display:flex; flex-direction:column; gap:10px; }
    .field label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; font-weight:600; }
    .field select{ width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; font-size:13px; outline:none; }
    .actions{ display:flex; gap:8px; margin-top:8px; }
    .btn{ border:1px solid transparent; background:var(--brand); color:#fff; padding:9px 12px; border-radius:999px; font-weight:600; font-size:13px; cursor:pointer; }
    .btn.secondary{ background:#fff; color:var(--ink); border-color:var(--line); }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chip{ font-size:12px; padding:6px 10px; border-radius:999px; background:var(--chip); border:1px solid #d7ecf4; }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:0; overflow:hidden; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .card-header{ padding:12px 14px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--line); gap:10px; flex-wrap:wrap; }
    .result-count{ font-size:13px; color:var(--muted) }
    .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .search{ width:300px; max-width:45%; }
    .search input{ width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:13px; }
    .export-btn{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:8px 12px; font-size:13px; cursor:pointer; }

    .subsearch{ padding:10px 14px; border-bottom:1px solid var(--line); display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .subsearch .label{ font-size:12px; color:var(--muted); font-weight:600; }
    .subsearch .input-wrap{ flex:1; min-width:260px; }
    .subsearch input{ width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:13px; }

    .table-wrap{ overflow:auto; max-height:calc(100vh - 300px); }
    table{ border-collapse:separate; border-spacing:0; width:100%; }
    thead th{ position:sticky; top:0; z-index:5; background:#f9fafb; border-bottom:1px solid var(--line); font-size:12px; text-align:left; padding:10px 12px; white-space:nowrap; }
    tbody td{ border-bottom:1px solid var(--line); font-size:12px; padding:9px 12px; vertical-align:top; }
    tbody tr:hover{ background:#fafcff }
    a.link{ color:var(--brand); text-decoration:none }
    a.link:hover{ text-decoration:underline }

    .badge{ display:inline-block; padding:4px 8px; border-radius:999px; font-weight:600; font-size:11px; border:1px solid transparent; white-space:nowrap; }
    .bd-sd{ background:#fff6e6; border-color:#ffe2ad; }
    .bd-smp{ background:#fff0e6; border-color:#ffdab8; }
    .bd-sma,.bd-smk{ background:#eaf5ff; border-color:#cfe8ff; }
    .bd-d1,.bd-d2,.bd-d3{ background:#eaf9f1; border-color:#c8efd9; }
    .bd-s1{ background:#eef7fb; border-color:#d7ecf4; }
    .bd-s2{ background:#efeaff; border-color:#d7ccff; }
    .bd-s3{ background:#ffeaf1; border-color:#ffcfe0; }
    .bd-lain{ background:#f3f4f6; border-color:#e5e7eb; }
    .bd-prov{ background:#eef7fb; border:1px solid #d7ecf4; }

    .pagination{ display:flex; justify-content:space-between; align-items:center; padding:10px 14px; border-top:1px solid var(--line); gap:10px; flex-wrap:wrap; }
    .pager{ display:flex; gap:8px; align-items:center; }
    .pg-btn{ background:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 12px; cursor:pointer; font-size:13px; }
    .pg-btn[disabled]{ opacity:.5; cursor:not-allowed }
    .page-info{ font-size:13px; color:var(--muted) }
    .page-size{ font-size:12px; color:var(--muted) }

    /* ===== Login Modal ===== */
    .login-wrap{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(14,23,38,.08); backdrop-filter:saturate(120%) blur(3px); padding:20px; z-index:50;
    }
    .login-card{
      width:100%; max-width:380px; background:#fff; border:1px solid var(--line); border-radius:20px; padding:20px;
      box-shadow:0 10px 20px rgba(0,0,0,.06);
    }
    .login-title{ font-weight:800; font-size:18px; margin:0 0 8px 0;}
    .login-sub{ color:var(--muted); font-size:13px; margin-bottom:14px;}
    .login-field{ margin-bottom:10px;}
    .login-field label{ display:block; font-size:12px; font-weight:600; color:var(--muted); margin-bottom:6px;}
    .login-field input{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:13px; outline:none; background:#fff;
    }
    .login-actions{ display:flex; gap:8px; align-items:center; margin-top:8px;}
    .login-error{ color:var(--danger); font-size:12px; margin-top:8px; display:none;}
    .caps{ font-size:11px; color:var(--muted); margin-top:6px; }
    .login-footnote{ margin-top:14px; font-size:12px; color:var(--muted); }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-inner">
      <div class="left-head">
        <img class="logo" alt="Lookerin Icon" src="https://res.cloudinary.com/dkihurh8o/image/upload/v1759062197/Logo_-_Lookerin-_Icon_he3evd.png">
        <div class="title">Database Pelamar Lookerin</div>
      </div>
      <div class="session hidden" id="sessionBox">
        <span id="sessionUser">@user</span>
        <button class="logout-btn" id="btnLogout" title="Keluar dari sesi">Log out</button>
      </div>
    </div>
  </header>

  <!-- Main App (tersembunyi sampai login) -->
  <main class="container hidden" id="appRoot" aria-live="polite">
    <div class="grid">
      <!-- Filter Panel -->
      <aside class="panel" aria-label="Filter">
        <h3>Filter</h3>
        <div class="filters">
          <div class="field">
            <label for="f-gender">JENIS KELAMIN</label>
            <select id="f-gender"><option value="">Semua</option></select>
          </div>
          <!-- MINAT POSISI dihapus -->
          <div class="field">
            <label for="f-kerjapertama">POSISI DILAMAR</label>
            <select id="f-kerjapertama"><option value="">Semua</option></select>
          </div>
          <div class="field">
            <label for="f-pendidikan">PENDIDIKAN TERAKHIR</label>
            <select id="f-pendidikan"><option value="">Semua</option></select>
          </div>
          <div class="field">
            <label for="f-provdom">PROVINSI DOMISILI</label>
            <select id="f-provdom"><option value="">Semua</option></select>
          </div>
          <div class="actions">
            <button class="btn" id="applyFilter">Terapkan</button>
            <button class="btn secondary" id="clearFilter">Clear</button>
          </div>
          <div class="chips" id="activeChips"></div>
        </div>
      </aside>

      <!-- Table Card -->
      <section class="card" aria-label="Tabel Pelamar">
        <div class="card-header">
          <div class="result-count" id="resultCount">Memuat data…</div>
          <div class="toolbar">
            <div class="search" title="Pencarian cepat">
              <input id="q" type="search" placeholder="Cari nama/email/WA/kota… (enter)">
            </div>
            <button class="export-btn" id="btnCsv">Export CSV</button>
            <button class="export-btn" id="btnXlsx">Export Excel</button>
          </div>
        </div>

        <!-- Subsearch dengan suggestion -->
        <div class="subsearch">
          <div class="label">Search (dengan saran posisi):</div>
          <div class="input-wrap">
            <input id="q2" list="jobs-list" placeholder="Ketik bebas… contoh: Admin, Sales, Barista">
            <datalist id="jobs-list"></datalist>
          </div>
          <button class="export-btn" id="btnSearch2">Cari</button>
          <button class="export-btn" id="btnClear2">Clear</button>
        </div>

        <div class="table-wrap">
          <table id="dataTable" aria-describedby="resultCount">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="pagination">
          <div class="page-size">Menampilkan <strong>50</strong> data per halaman</div>
          <div class="pager">
            <button class="pg-btn" id="pg-prev">Prev</button>
            <span class="page-info" id="pageInfo">Hal 1 / 1</span>
            <button class="pg-btn" id="pg-next">Next</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Login Modal -->
  <div class="login-wrap" id="loginWrap" aria-modal="true" role="dialog" aria-labelledby="loginTitle">
    <div class="login-card">
      <h1 class="login-title" id="loginTitle">Masuk ke CAREER SIMGROUP</h1>
      <p class="login-sub">Gunakan akun yang telah diberikan.</p>
      <form id="loginForm" autocomplete="on">
        <div class="login-field">
          <label for="username">Username</label>
          <input id="username" name="username" required placeholder="contoh: sourcingho">
        </div>
        <div class="login-field">
          <label for="password">Password</label>
          <input id="password" name="password" type="password" required placeholder="••••••••">
        </div>
        <div class="login-actions">
          <button type="submit" class="btn">Login</button>
          <button type="button" class="btn secondary" id="btnClearLogin">Clear</button>
        </div>
        <div class="login-error" id="loginError">Username / password salah.</div>
        <div class="caps" id="capsWarn" style="display:none;">Caps Lock aktif.</div>
        <div class="login-footnote">Hubungi Sourcing HO untuk login dan password.</div>
      </form>
    </div>
  </div>

  <script>
    // ========= AUTH =========
    const USERS = {
      "sourcingho": "sourcingho",
      "anya": "regional1",
      "rizkia": "regional2",
      "yoghi": "regional3"
    };
    const SESSION_KEY = "lookerin_session_v1";

    const loginWrap = document.getElementById('loginWrap');
    const appRoot   = document.getElementById('appRoot');
    const sessionBox = document.getElementById('sessionBox');
    const sessionUser = document.getElementById('sessionUser');
    const btnLogout = document.getElementById('btnLogout');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const capsWarn = document.getElementById('capsWarn');
    const btnClearLogin = document.getElementById('btnClearLogin');

    function getSession(){
      try{
        const raw = localStorage.getItem(SESSION_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(obj && obj.user){ return obj; }
      }catch{}
      return null;
    }
    function setSession(user){
      const payload = { user, ts: Date.now() };
      localStorage.setItem(SESSION_KEY, JSON.stringify(payload));
    }
    function clearSession(){
      localStorage.removeItem(SESSION_KEY);
    }

    function showAppFor(user){
      sessionUser.textContent = '@' + user;
      sessionBox.classList.remove('hidden');
      loginWrap.classList.add('hidden');
      appRoot.classList.remove('hidden');
      if (!window.__dataLoaded){
        window.__dataLoaded = true;
        loadData();
      }
    }
    function showLogin(){
      appRoot.classList.add('hidden');
      sessionBox.classList.add('hidden');
      loginWrap.classList.remove('hidden');
      loginError.style.display = 'none';
      setTimeout(()=>document.getElementById('username').focus(), 50);
    }

    // Inisialisasi
    (function initAuth(){
      const ses = getSession();
      if(ses && ses.user){
        showAppFor(ses.user);
      }else{
        showLogin();
      }
    })();

    // Form events
    loginForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      loginError.style.display = 'none';
      const u = (document.getElementById('username').value || "").trim().toLowerCase();
      const p = (document.getElementById('password').value || "");
      if(USERS[u] && USERS[u] === p){
        setSession(u);
        showAppFor(u);
      }else{
        loginError.style.display = 'block';
      }
    });
    btnClearLogin.addEventListener('click', ()=>{
      document.getElementById('username').value = "";
      document.getElementById('password').value = "";
      loginError.style.display = 'none';
      document.getElementById('username').focus();
    });
    document.getElementById('password').addEventListener('keyup', (e)=>{
      const on = e.getModifierState && e.getModifierState('CapsLock');
      capsWarn.style.display = on ? 'block' : 'none';
    });
    btnLogout.addEventListener('click', ()=>{
      clearSession();
      window.__dataLoaded = false;
      showLogin();
    });

    // ========= KONFIGURASI DATA =========
    const SHEET_ID = "1ESGkZf2P_0XMnyJgb7wN_L_Xo144nO6GPg30rrBZW58";
    const SHEET_NAME = "lookerin";
    const ROWS_PER_PAGE = 50;

    const COLUMNS_ORDER = [
      "TIMESTAMP","EMAIL AKTIF","SUMBER INFORMASI LOWONGAN","NAMA LENGKAP","TANGGAL LAHIR",
      "NOMOR WA AKTIF","NOMOR HP AKTIF","JENIS KELAMIN","PENGALAMAN KERJA TERAKHIR","DURASI PENGALAMAN KERJA",
      "MINAT POSISI KERJA PERTAMA","PENDIDIKAN TERAKHIR",
      "NAMA SEKOLAH / NAMA UNIVERITAS","JURUSAN","KEPEMILIKAN KENDARAAN","KEPEMILIKAN SIM AKTIF",
      "ALAMAT DOMISILI","PROVINSI DOMISILI","KECAMATAN","KELURAHAN",
      "PROVINSI MINAT PENEMPATAN","KOTA MINAT PENEMPATAN","UPLOAD CV","GAJI TERAKHIR (IDR)","HARAPAN GAJI (IDR)"
    ];

    // Elemen UI
    const thead = document.getElementById('thead');
    const tbody = document.getElementById('tbody');
    const resultCount = document.getElementById('resultCount');
    const pageInfo = document.getElementById('pageInfo');
    const btnPrev = document.getElementById('pg-prev');
    const btnNext = document.getElementById('pg-next');

    // Filter elements
    const fGender = document.getElementById('f-gender');
    const fKerjaPertama = document.getElementById('f-kerjapertama');
    const fPendidikan = document.getElementById('f-pendidikan');
    const fProvDom = document.getElementById('f-provdom');
    const btnApply = document.getElementById('applyFilter');
    const btnClear = document.getElementById('clearFilter');
    const chips = document.getElementById('activeChips');

    // Search
    const searchInput = document.getElementById('q');
    const searchInput2 = document.getElementById('q2');
    const jobsList = document.getElementById('jobs-list');
    const btnSearch2 = document.getElementById('btnSearch2');
    const btnClear2 = document.getElementById('btnClear2');

    // Export
    const btnCsv = document.getElementById('btnCsv');
    const btnXlsx = document.getElementById('btnXlsx');

    // Data state
    let rowsRaw = [];
    let rowsFiltered = [];
    let currentPage = 1;

    const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

    // ======== HELPERS & SEARCH INDEX ========
    function vToStr(v){ return (v==null? "": String(v)).trim(); }
    function norm(s){
      return vToStr(s)
        .toLowerCase()
        .normalize('NFKD')
        .replace(/[^\p{L}\p{N}\s]/gu, ' ')
        .replace(/\s+/g,' ')
        .trim();
    }
    function includesToken(hay, needle){
      if(!needle) return true;
      return hay.includes(needle);
    }

    let rowsIndex = []; // sejajar dengan rowsRaw
    const hayQuickKeys = [
      "NAMA LENGKAP","EMAIL AKTIF","NOMOR WA AKTIF","ALAMAT DOMISILI",
      "KOTA MINAT PENEMPATAN","PROVINSI MINAT PENEMPATAN","PROVINSI DOMISILI"
    ];

    function buildIndex(){
      rowsIndex = rowsRaw.map(r=>{
        const genderN     = norm(r["JENIS KELAMIN"]);
        const minat1N     = norm(r["MINAT POSISI KERJA PERTAMA"]);
        const pendidikanN = norm(r["PENDIDIKAN TERAKHIR"]);
        const provdomN    = norm(r["PROVINSI DOMISILI"]);

        const hayQuick = norm(hayQuickKeys.map(k=>r[k]).join(' '));
        const hayAll   = norm(Object.values(r).join(' '));

        return { genderN, minat1N, pendidikanN, provdomN, hayQuick, hayAll };
      });
    }

    function uniqueSorted(values){
      return [...new Set(values.filter(v => v !== "" && v != null))].sort((a,b)=>{
        const A = (""+vToStr(a)).toLowerCase(), B = (""+vToStr(b)).toLowerCase();
        if (A < B) return -1; if (A > B) return 1; return 0;
      });
    }
    function populateSelect(selectEl, items){
      const current = selectEl.value || "";
      selectEl.innerHTML = '<option value="">Semua</option>' + items.map(v => `<option value="${escapeHtml(vToStr(v))}">${escapeHtml(vToStr(v))}</option>`).join("");
      if (items.includes(current)) selectEl.value = current;
    }
    function getCol(name){ return rowsRaw.map(r => r[name] ?? ""); }

    function populateFilters(){
      populateSelect(fGender, uniqueSorted(getCol("JENIS KELAMIN")));
      populateSelect(fKerjaPertama, uniqueSorted(getCol("MINAT POSISI KERJA PERTAMA")));
      populateSelect(fPendidikan, uniqueSorted(getCol("PENDIDIKAN TERAKHIR")));
      populateSelect(fProvDom, uniqueSorted(getCol("PROVINSI DOMISILI")));
    }

    function populateJobSuggestions(){
      const jobs = uniqueSorted(getCol("MINAT POSISI KERJA PERTAMA").map(v => (v||"").toString()));
      jobsList.innerHTML = jobs.map(j => `<option value="${escapeHtml(j)}"></option>`).join("");
    }

    function escapeHtml(str){
      return (str==null? "": String(str))
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function linkifyIfUrl(value){
      const v = String(value || "").trim();
      if (!v) return "";
      if (/^https?:\/\//i.test(v)){
        return `<a class="link" href="${escapeHtml(v)}" target="_blank" rel="noopener noreferrer">Buka</a>`;
      }
      return escapeHtml(v);
    }

    function pendidikanClass(valRaw){
      const v = (valRaw || "").toString().toLowerCase();
      if (/\bsd\b/.test(v)) return "bd-sd";
      if (/\bsmp\b/.test(v)) return "bd-smp";
      if (/\b(sm[ak])\b/.test(v) || /sma|smk/.test(v)) return "bd-sma";
      if (/\bd[123]\b/.test(v) || /d1|d2|d3/.test(v)) return "bd-d3";
      if (/\bs1\b/.test(v) || /sarjana\b/.test(v)) return "bd-s1";
      if (/\bs2\b/.test(v) || /magister\b/.test(v)) return "bd-s2";
      if (/\bs3\b/.test(v) || /doktor\b/.test(v)) return "bd-s3";
      return "bd-lain";
    }

    function parseGvizDate(v){
      if (v == null) return null;
      if (typeof v === "string"){
        const s = v.trim();
        const m = s.match(/^Date\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+),\s*(\d+),\s*(\d+))?\)$/);
        if (m){
          const y = +m[1], mo = +m[2], d = +m[3];
          const hh = +(m[4] ?? 0), mm = +(m[5] ?? 0), ss = +(m[6] ?? 0);
          return new Date(Date.UTC(y, mo, d, hh, mm, ss));
        }
        const dIso = new Date(s);
        if (!isNaN(dIso)) return dIso;
        const num = Number(s);
        if (!isNaN(num)) return sheetsSerialToDate(num);
        return null;
      }
      if (typeof v === "number"){ return sheetsSerialToDate(v); }
      if (typeof v === "object" && v !== null && v.v){ return parseGvizDate(v.v); }
      return null;
    }
    function sheetsSerialToDate(n){
      const ms = (n - 25569) * 86400 * 1000;
      const d = new Date(ms);
      return isNaN(d) ? null : d;
    }
    function formatDateShortID(v){
      const d = parseGvizDate(v);
      if (!d) return escapeHtml(vToStr(v));
      const months = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sept','Okt','Nov','Des'];
      const day = String(d.getDate()).padStart(2,'0');
      const mon = months[d.getMonth()];
      const year = d.getFullYear();
      return `${day} ${mon} ${year}`;
    }

    function formatIDNumber(value){
      if (value == null || value === "") return "";
      const s = String(value).toString().replace(/[^\d\-.,]/g,'').replace(',', '.');
      const num = Number(s);
      if (isNaN(num)) return escapeHtml(String(value));
      return num.toLocaleString('id-ID');
    }

    async function loadData(){
      try{
        const res = await fetch(GVIZ_URL + '&_ts=' + Date.now(), {cache:"no-store"});
        const txt = await res.text();
        const jsonStr = txt.substring(txt.indexOf('{'), txt.lastIndexOf('}') + 1);
        const data = JSON.parse(jsonStr);

        const cols = data.table.cols.map(c => c.label?.trim() || c.id || "");
        const rows = data.table.rows;

        rowsRaw = rows.map(r => {
          const obj = {};
          cols.forEach((label, i) => {
            const cell = r.c[i];
            let v = (cell && (cell.f ?? cell.v)) ?? "";
            obj[label] = v;
          });
          return obj;
        });

        renderHeader();
        populateFilters();
        populateJobSuggestions();
        buildIndex();              // indeks sekali
        applyFilters();            // render awal
      }catch(err){
        console.error(err);
        resultCount.textContent = "Gagal memuat data. Pastikan sheet 'lookerin' bisa diakses publik.";
      }
    }

    function renderHeader(){
      thead.innerHTML = "";
      const tr = document.createElement('tr');
      COLUMNS_ORDER.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        tr.appendChild(th);
      });
      thead.appendChild(tr);
    }

    function applyFilters(){
      const sGender = norm(fGender.value);
      const sKerja1 = norm(fKerjaPertama.value);
      const sPend   = norm(fPendidikan.value);
      const sProv   = norm(fProvDom.value);
      const q       = norm(searchInput.value);
      const q2      = norm(searchInput2.value);

      chips.innerHTML = "";
      [["JENIS KELAMIN",sGender],["POSISI DILAMAR",sKerja1],["PENDIDIKAN TERAKHIR",sPend],["PROVINSI DOMISILI",sProv],["Cari (atas)",q],["Cari (suggest)",q2]]
      .forEach(([label,val])=>{
        if(!val) return;
        const span=document.createElement('span'); span.className="chip"; span.textContent=`${label}: ${val}`; chips.appendChild(span);
      });

      rowsFiltered = [];
      for (let i=0;i<rowsRaw.length;i++){
        const r  = rowsRaw[i];
        const ix = rowsIndex[i];

        if (sGender && ix.genderN !== sGender) continue;
        if (sKerja1 && !includesToken(ix.minat1N, sKerja1)) continue; // contains agar robust
        if (sPend && ix.pendidikanN !== sPend) continue;
        if (sProv && ix.provdomN !== sProv) continue;

        if (q && !includesToken(ix.hayQuick, q)) continue;
        if (q2 && !includesToken(ix.hayAll, q2)) continue;

        rowsFiltered.push(r);
      }

      currentPage = 1;
      renderTablePage();
    }

    function renderTablePage(){
      const total = rowsFiltered.length;
      const totalPages = Math.max(1, Math.ceil(total / ROWS_PER_PAGE));
      currentPage = Math.min(Math.max(1, currentPage), totalPages);

      const start = (currentPage - 1) * ROWS_PER_PAGE;
      const end = Math.min(start + ROWS_PER_PAGE, total);

      const slice = rowsFiltered.slice(start, end);

      const rowsHtml = slice.map(r => {
        return `<tr>
          ${COLUMNS_ORDER.map(col => {
            const raw = r[col];
            if (col === "UPLOAD CV") return `<td>${linkifyIfUrl(raw)}</td>`;
            if (col === "PENDIDIKAN TERAKHIR"){
              const cls = pendidikanClass(raw);
              return `<td><span class="badge ${cls}">${escapeHtml(vToStr(raw))}</span></td>`;
            }
            if (col === "PROVINSI DOMISILI"){
              return `<td><span class="badge bd-prov">${escapeHtml(vToStr(raw))}</span></td>`;
            }
            if (col === "GAJI TERAKHIR (IDR)" || col === "HARAPAN GAJI (IDR)"){
              return `<td>${formatIDNumber(raw)}</td>`;
            }
            if (col === "TIMESTAMP"){
              return `<td>${formatDateShortID(raw)}</td>`;
            }
            return `<td>${escapeHtml(vToStr(raw))}</td>`;
          }).join("")}
        </tr>`;
      }).join("");

      tbody.innerHTML = rowsHtml || `<tr><td colspan="${COLUMNS_ORDER.length}" style="padding:16px;color:var(--muted);">Tidak ada data.</td></tr>`;

      resultCount.textContent = `Total ${total.toLocaleString('id-ID')} data • Menampilkan ${total? (start+1):0}-${end} `;
      pageInfo.textContent = `Hal ${currentPage} / ${totalPages}`;

      btnPrev.disabled = currentPage <= 1 || total === 0;
      btnNext.disabled = currentPage >= totalPages || total === 0;
    }

    function filteredDataAsArray(){
      const data = rowsFiltered.length ? rowsFiltered : rowsRaw;
      const arr = data.map(r => COLUMNS_ORDER.map(k => {
        let v = r[k];
        if (k === "TIMESTAMP"){
          const d = parseGvizDate(v);
          if (d){
            const months = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sept','Okt','Nov','Des'];
            const day = String(d.getDate()).padStart(2,'0');
            const mon = months[d.getMonth()];
            const year = d.getFullYear();
            return `${day} ${mon} ${year}`;
          }
          return vToStr(v);
        }
        return v ?? "";
      }));
      return { header: COLUMNS_ORDER.slice(), rows: arr };
    }

    function downloadBlob(content, filename, type){
      const blob = new Blob([content], {type});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      URL.revokeObjectURL(url); a.remove();
    }

    function exportCSV(){
      const { header, rows } = filteredDataAsArray();
      const escapeCsv = v => {
        v = (v ?? "").toString().replaceAll('"','""');
        if (/[",\n]/.test(v)) return `"${v}"`;
        return v;
      };
      const lines = [
        header.map(escapeCsv).join(','),
        ...rows.map(row => row.map(escapeCsv).join(','))
      ];
      downloadBlob(lines.join('\n'), 'pelamar_lookerin.csv', 'text/csv;charset=utf-8;');
    }

    function exportXLSX(){
      const { header, rows } = filteredDataAsArray();
      const aoa = [header, ...rows];
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      ws['!cols'] = header.map(h => ({ wch: Math.max(12, String(h).length + 2) }));
      XLSX.utils.book_append_sheet(wb, ws, 'Pelamar');
      XLSX.writeFile(wb, 'pelamar_lookerin.xlsx');
    }

    // ===== Events =====
    document.getElementById('pg-prev').addEventListener('click', ()=>{ currentPage--; renderTablePage(); });
    document.getElementById('pg-next').addEventListener('click', ()=>{ currentPage++; renderTablePage(); });

    document.getElementById('applyFilter').addEventListener('click', applyFilters);
    document.getElementById('clearFilter').addEventListener('click', ()=>{
      fGender.value = "";
      fKerjaPertama.value = "";
      fPendidikan.value = "";
      fProvDom.value = "";
      searchInput.value = "";
      searchInput2.value = "";
      applyFilters();
    });

    // Trigger otomatis saat pilih filter
    [fGender, fKerjaPertama, fPendidikan, fProvDom].forEach(el=>{
      el.addEventListener('change', applyFilters);
    });

    // Debounce pencarian agar tidak berat saat ketik
    let __qDeb;
    function debounce(fn, wait=300){
      return function(...args){
        clearTimeout(__qDeb);
        __qDeb = setTimeout(()=>fn.apply(this,args), wait);
      };
    }
    searchInput.addEventListener('input', debounce(applyFilters, 300));
    searchInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') applyFilters(); });

    // Subsearch tetap manual via tombol, tapi dukung Enter
    document.getElementById('btnSearch2').addEventListener('click', applyFilters);
    document.getElementById('btnClear2').addEventListener('click', ()=>{ searchInput2.value=""; applyFilters(); });
    searchInput2.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') applyFilters(); });

    document.getElementById('btnCsv').addEventListener('click', exportCSV);
    document.getElementById('btnXlsx').addEventListener('click', exportXLSX);
  </script>
</body>
</html>
